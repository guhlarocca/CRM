{% extends "base.html" %}

{% block content %}
<div class="container-fluid px-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="#" class="text-muted">CRM</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('leads') }}" class="text-muted">Leads</a></li>
            <li class="breadcrumb-item active" aria-current="page">Editar Lead</li>
        </ol>
    </nav>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Editar Lead</h6>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('editar_lead', lead_id=lead.id) }}">
                <div class="row">
                    <!-- Informações Básicas -->
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <i class="fas fa-user me-2"></i>Informações Básicas
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="nome" class="form-label">Nome Completo*</label>
                                    <input type="text" class="form-control" id="nome" name="nome" value="{{ lead.nome if lead.nome else '' }}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Principal*</label>
                                    <input type="email" class="form-control" id="email" name="email" value="{{ lead.email if lead.email else '' }}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="telefone" class="form-label">Telefone Principal</label>
                                    <input type="tel" class="form-control" id="telefone" name="telefone" value="{{ lead.telefone if lead.telefone else '' }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informações de Contato -->
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header bg-info text-white">
                                <i class="fas fa-envelope me-2"></i>Informações de Contato
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="email_comercial" class="form-label">Email Comercial</label>
                                    <input type="email" class="form-control" id="email_comercial" name="email_comercial" value="{{ lead.email_comercial if lead.email_comercial else '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="email_comercial_02" class="form-label">Email Comercial 02</label>
                                    <input type="email" class="form-control" id="email_comercial_02" name="email_comercial_02" value="{{ lead.email_comercial_02 if lead.email_comercial_02 else '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="email_comercial_03" class="form-label">Email Comercial 03</label>
                                    <input type="email" class="form-control" id="email_comercial_03" name="email_comercial_03" value="{{ lead.email_comercial_03 if lead.email_comercial_03 else '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="email_financeiro" class="form-label">Email Financeiro</label>
                                    <input type="email" class="form-control" id="email_financeiro" name="email_financeiro" value="{{ lead.email_financeiro if lead.email_financeiro else '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="telefone_comercial" class="form-label">Telefone Comercial</label>
                                    <input type="tel" class="form-control" id="telefone_comercial" name="telefone_comercial" value="{{ lead.telefone_comercial if lead.telefone_comercial else '' }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Localização e Empresa -->
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <i class="fas fa-map-marker-alt me-2"></i>Localização e Empresa
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="cidade" class="form-label">Cidade</label>
                                    <input type="text" class="form-control" id="cidade" name="cidade" value="{{ lead.cidade if lead.cidade else '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="estado" class="form-label">Estado</label>
                                    <select class="form-select" id="estado" name="estado">
                                        <option value="">Selecione o Estado</option>
                                        <option value="AC" {% if lead.estado == 'AC' %}selected{% endif %}>Acre</option>
                                        <option value="AL" {% if lead.estado == 'AL' %}selected{% endif %}>Alagoas</option>
                                        <option value="AP" {% if lead.estado == 'AP' %}selected{% endif %}>Amapá</option>
                                        <option value="AM" {% if lead.estado == 'AM' %}selected{% endif %}>Amazonas</option>
                                        <option value="BA" {% if lead.estado == 'BA' %}selected{% endif %}>Bahia</option>
                                        <option value="CE" {% if lead.estado == 'CE' %}selected{% endif %}>Ceará</option>
                                        <option value="DF" {% if lead.estado == 'DF' %}selected{% endif %}>Distrito Federal</option>
                                        <option value="ES" {% if lead.estado == 'ES' %}selected{% endif %}>Espírito Santo</option>
                                        <option value="GO" {% if lead.estado == 'GO' %}selected{% endif %}>Goiás</option>
                                        <option value="MA" {% if lead.estado == 'MA' %}selected{% endif %}>Maranhão</option>
                                        <option value="MT" {% if lead.estado == 'MT' %}selected{% endif %}>Mato Grosso</option>
                                        <option value="MS" {% if lead.estado == 'MS' %}selected{% endif %}>Mato Grosso do Sul</option>
                                        <option value="MG" {% if lead.estado == 'MG' %}selected{% endif %}>Minas Gerais</option>
                                        <option value="PA" {% if lead.estado == 'PA' %}selected{% endif %}>Pará</option>
                                        <option value="PB" {% if lead.estado == 'PB' %}selected{% endif %}>Paraíba</option>
                                        <option value="PR" {% if lead.estado == 'PR' %}selected{% endif %}>Paraná</option>
                                        <option value="PE" {% if lead.estado == 'PE' %}selected{% endif %}>Pernambuco</option>
                                        <option value="PI" {% if lead.estado == 'PI' %}selected{% endif %}>Piauí</option>
                                        <option value="RJ" {% if lead.estado == 'RJ' %}selected{% endif %}>Rio de Janeiro</option>
                                        <option value="RN" {% if lead.estado == 'RN' %}selected{% endif %}>Rio Grande do Norte</option>
                                        <option value="RS" {% if lead.estado == 'RS' %}selected{% endif %}>Rio Grande do Sul</option>
                                        <option value="RO" {% if lead.estado == 'RO' %}selected{% endif %}>Rondônia</option>
                                        <option value="RR" {% if lead.estado == 'RR' %}selected{% endif %}>Roraima</option>
                                        <option value="SC" {% if lead.estado == 'SC' %}selected{% endif %}>Santa Catarina</option>
                                        <option value="SP" {% if lead.estado == 'SP' %}selected{% endif %}>São Paulo</option>
                                        <option value="SE" {% if lead.estado == 'SE' %}selected{% endif %}>Sergipe</option>
                                        <option value="TO" {% if lead.estado == 'TO' %}selected{% endif %}>Tocantins</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="empresa" class="form-label">Empresa</label>
                                    <input type="text" class="form-control" id="empresa" name="empresa" value="{{ lead.empresa if lead.empresa else '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="cargo" class="form-label">Cargo</label>
                                    <input type="text" class="form-control" id="cargo" name="cargo" value="{{ lead.cargo if lead.cargo else '' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Contatos Adicionais -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-warning text-white">
                                <i class="fas fa-address-book me-2"></i>Contatos Adicionais
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="contato_01" class="form-label">Contato 01</label>
                                    <input type="text" class="form-control" id="contato_01" name="contato_01" value="{{ lead.contato_01 if lead.contato_01 else '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="contato_02" class="form-label">Contato 02</label>
                                    <input type="text" class="form-control" id="contato_02" name="contato_02" value="{{ lead.contato_02 if lead.contato_02 else '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="observacoes" class="form-label">Observações</label>
                                    <textarea class="form-control" id="observacoes" name="observacoes" rows="4">{{ lead.observacoes if lead.observacoes else '' }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vendedor e Status -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-secondary text-white">
                                <i class="fas fa-chart-line me-2"></i>Vendedor e Status
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="vendedor_id" class="form-label">Vendedor Responsável</label>
                                    <select class="form-select" id="vendedor_id" name="vendedor_id" required>
                                        {% for vendedor in vendedores %}
                                        <option value="{{ vendedor.id }}" {% if vendedor.id == lead.vendedor_id %}selected{% endif %}>
                                            {{ vendedor.nome }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="estagio_atual" class="form-label">Estágio Atual</label>
                                    <select class="form-select" id="estagio_atual" name="estagio_atual" required>
                                        <option value="Não Iniciado" {% if lead.estagio_atual == 'Não Iniciado' %}selected{% endif %}>Não Iniciado</option>
                                        <option value="Enviado Email" {% if lead.estagio_atual == 'Enviado Email' %}selected{% endif %}>Enviado Email</option>
                                        <option value="Sem retorno Email" {% if lead.estagio_atual == 'Sem retorno Email' %}selected{% endif %}>Sem retorno Email</option>
                                        <option value="Retorno Agendado" {% if lead.estagio_atual == 'Retorno Agendado' %}selected{% endif %}>Retorno Agendado</option>
                                        <option value="Linkedin" {% if lead.estagio_atual == 'Linkedin' %}selected{% endif %}>Linkedin</option>
                                        <option value="Sem Retorno Linkedin" {% if lead.estagio_atual == 'Sem Retorno Linkedin' %}selected{% endif %}>Sem Retorno Linkedin</option>
                                        <option value="WhatsApp" {% if lead.estagio_atual == 'WhatsApp' %}selected{% endif %}>WhatsApp</option>
                                        <option value="Sem Retorno WhatsApp" {% if lead.estagio_atual == 'Sem Retorno WhatsApp' %}selected{% endif %}>Sem Retorno WhatsApp</option>
                                        <option value="Email Despedida" {% if lead.estagio_atual == 'Email Despedida' %}selected{% endif %}>Email Despedida</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="venda_fechada" name="venda_fechada" {% if lead.venda_fechada %}checked{% endif %}>
                                        <label class="form-check-label" for="venda_fechada">
                                            Venda Fechada
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="data_venda" class="form-label">Data da Venda</label>
                                    <input type="date" class="form-control" id="data_venda" name="data_venda" value="{{ lead.data_venda.strftime('%Y-%m-%d') if lead.data_venda else '' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        $('form').on('submit', function(e) {
            // e.preventDefault(); // Descomente para testar sem enviar o formulário
            
            // Debug: mostrar todos os dados do formulário
            var formData = new FormData(this);
            console.log('Dados do formulário:');
            for (var pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }
            
            // Debug: mostrar especificamente o estágio atual
            console.log('Estágio atual selecionado:', $('#estagio_atual').val());
        });
    });
</script>

<script>
    // Máscara de telefone
    document.getElementById('telefone').addEventListener('input', function(e) {
        let telefone = e.target.value.replace(/\D/g, '');
        if (telefone.length > 11) telefone = telefone.slice(0, 11);
        
        if (telefone.length > 10) {
            // Celular
            telefone = telefone.replace(/^(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        } else if (telefone.length > 6) {
            // Telefone fixo
            telefone = telefone.replace(/^(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
        } else if (telefone.length > 2) {
            telefone = telefone.replace(/^(\d{2})(\d{0,5})/, '($1) $2');
        }
        
        e.target.value = telefone;
    });
</script>
{% endblock %}
